"use strict";var _get=function e(t,n,r){null===t&&(t=Function.prototype);var i=Object.getOwnPropertyDescriptor(t,n);if(void 0===i){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,n,r)}if("value"in i)return i.value;var o=i.get;return void 0!==o?o.call(r):void 0},_createClass=function(){function r(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}return function(e,t,n){return t&&r(e.prototype,t),n&&r(e,n),e}}();function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(function(){var o=[].indexOf,_=function(e,t){if(!(e instanceof t))throw new Error("Bound instance method accessed before binding")};jQuery(document).ready(function(i){var r,a;return window.WC_Braintree_Payment_Form_Handler=function(){function t(e){_classCallCheck(this,t),this.show_integration_ui=this.show_integration_ui.bind(this),this.hide_integration_ui=this.hide_integration_ui.bind(this),this.id=e.id,this.id_dasherized=e.id_dasherized,this.type=e.type,this.debug=e.debug,this.client_token_nonce=e.client_token_nonce,this.params=window.wc_braintree_params}return _createClass(t,[{key:"init",value:function(){return this.is_sdk_ready()?i("form.checkout").length?this.handle_checkout_page():i("form#order_review").length?this.handle_pay_page():i("form#add_payment_method").length?this.handle_add_payment_method_page():void 0:console.error("Braintree SDK is missing.")}},{key:"handle_checkout_page",value:function(){var e=this;return this.form=i("form.checkout"),this.form_ui_selector=".woocommerce-checkout-payment",i(document.body).on("updated_checkout",function(){return e.setup_braintree()}),i(document.body).on("updated_checkout",function(){return e.handle_saved_payment_methods()}),i(document.body).on("checkout_error",function(){return e.handle_checkout_error()}),this.form.on("checkout_place_order_"+this.id,function(){if(e.is_selected())return e.block_ui(),e.verify_form()})}},{key:"handle_checkout_error",value:function(){return this.unblock_ui()}},{key:"handle_pay_page",value:function(){var e=this;return this.form=i("form#order_review"),this.form_ui_selector="#payment",this.handle_saved_payment_methods(),this.setup_braintree(),this.form.submit(function(){if(e.is_selected())return e.block_ui(),e.verify_form()})}},{key:"handle_add_payment_method_page",value:function(){var e=this;return this.form=i("form#add_payment_method"),this.form_ui_selector="#payment",this.setup_braintree(),this.form.submit(function(){if(e.is_selected())return e.block_ui(),e.verify_form()})}},{key:"verify_form",value:function(){return!!this.using_payment_token()||!!this.has_payment_nonce()&&void 0}},{key:"submit_form",value:function(e){return i("input[name=wc_"+this.id+"_payment_nonce]").val(e),this.form.submit()}},{key:"handle_saved_payment_methods",value:function(){var e,n=this;if(e=i("div.js-wc-"+this.id_dasherized+"-new-payment-method-form"),i("input.js-wc-"+this.id_dasherized+"-payment-token").change(function(){return i("input.js-wc-"+n.id_dasherized+"-payment-token:checked").val()?e.slideUp(200):e.slideDown(200)}).change(),i("input#createaccount").change(function(e){var t;return t=i("input.js-wc-"+n.id_dasherized+"-tokenize-payment-method").closest("p.form-row"),i(e.target).is(":checked")?(t.slideDown(),t.next().show()):(t.hide(),t.next().hide())}),!i("input#createaccount").is(":checked"))return i("input#createaccount").change()}},{key:"setup_braintree",value:function(){return this.block_ui(),i("input[name=wc_"+this.id+"_payment_nonce]").val(""),null!=this.client?this.setup_integration():this.create_client()}},{key:"create_client",value:function(){var r=this;return this.get_client_token().done(function(e){return e.success?braintree.client.create({authorization:e.data}).then(function(e){return r.client=e,r.setup_integration()}).catch(function(e){return r.handle_integration_error(e),r.unblock_ui()}):r.handle_integration_error(e.data)}).fail(function(e,t,n){return r.handle_integration_error({message:"Could not retrieve the client token via AJAX: "+n})}).always(function(){return r.unblock_ui()})}},{key:"get_client_token",value:function(){var e;return this.id+"_client_token_nonce",e={action:"wc_"+this.id+"_get_client_token",nonce:this.client_token_nonce},i.post(this.params.ajax_url,e)}},{key:"setup_integration",value:function(){var t=this;return this.get_integration_class().create(this.get_integration_options()).then(function(e){return t.integration=e,t.show_integration_ui(),t.do_integration_ready(),i(document).trigger("wc_"+t.id+"_integration_ready",t.integration)},function(e){return t.handle_integration_error(e),t.unblock_ui()})}},{key:"refresh_braintree",value:function(){var e=this;if(null!=this.integration)return this.block_ui(),this.integration.teardown(function(){return e.integration=null,e.setup_braintree()})}},{key:"teardown_braintree",value:function(){var e=this;if(null!=this.integration)return this.block_ui(),this.integration.teardown(function(){return e.integration=null,e.unblock_ui()})}},{key:"do_integration_ready",value:function(){}},{key:"get_integration_options",value:function(){return{client:this.client}}},{key:"get_integration_class",value:function(){}},{key:"handle_integration_error",value:function(e){return this.log("Integration error: "+e.message,e),this.hide_integration_ui(),this.unblock_ui()}},{key:"handle_payment_error",value:function(e){return this.log("Payment error: "+e.message,e),this.render_error(this.get_user_message(e)),this.unblock_ui()}},{key:"render_error",value:function(e){return i(".woocommerce-error, .woocommerce-message").remove(),this.form.prepend('<div class="woocommerce-error">'+e+"</div>").removeClass("processing").unblock(),i("html, body").animate({scrollTop:this.form.offset().top-100},1e3),i("input[name=wc_"+this.id+"_payment_nonce]").val(""),this.form.trigger("wc_"+this.id+"_rendered_error"),this.unblock_ui()}},{key:"get_user_message",value:function(e){return this.params.payment_error_message}},{key:"show_integration_ui",value:function(){if(i("div.js-wc-"+this.id_dasherized+"-new-payment-method-form").find(".woocommerce-error").remove(),i("input#createaccount").length&&i("input#createaccount").is(":checked"))return i("div.js-wc-"+this.id_dasherized+"-new-payment-method-form").find(".form-row").show()}},{key:"hide_integration_ui",value:function(){return i("div.js-wc-"+this.id_dasherized+"-new-payment-method-form").prepend('<div class="woocommerce-error">'+this.params.integration_error_message+"</div>"),i("div.js-wc-"+this.id_dasherized+"-new-payment-method-form").find(".form-row").hide()}},{key:"block_ui",value:function(){return i(this.form_ui_selector).block({message:null,overlayCSS:{background:"#fff",opacity:.6}})}},{key:"unblock_ui",value:function(){return i(this.form_ui_selector).unblock()}},{key:"is_selected",value:function(){return this.get_selected_gateway_id()===this.id}},{key:"is_sdk_ready",value:function(){return"undefined"!=typeof braintree&&null!==braintree&&null!=braintree.client&&null!=this.get_integration_class()}},{key:"has_payment_nonce",value:function(){return this.form.find("input[name=wc_"+this.id+"_payment_nonce]").val()}},{key:"using_payment_token",value:function(){return this.form.find("input.js-wc-"+this.id_dasherized+"-payment-token:checked").val()}},{key:"get_selected_gateway_id",value:function(){return this.form.find("input[name=payment_method]:checked").val()}},{key:"log",value:function(e,t){if(this.debug)return console.log("[Braintree] "+e),console.log(t)}}]),t}(),r=window.WC_Braintree_Credit_Card_Payment_Form_Handler=function(e){function a(e){_classCallCheck(this,a);var t=_possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,e));return t.add_3ds_ui=t.add_3ds_ui.bind(t),t.remove_3ds_ui=t.remove_3ds_ui.bind(t),t.show_integration_ui=t.show_integration_ui.bind(t),t.hide_integration_ui=t.hide_integration_ui.bind(t),t.csc_required=e.csc_required,t.hosted_fields_styles=e.hosted_fields_styles,t.threeds=e.threeds,t.enabled_card_types=e.enabled_card_types,t.init(),t}return _inherits(a,WC_Braintree_Payment_Form_Handler),_createClass(a,[{key:"handle_checkout_error",value:function(){return _get(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"handle_checkout_error",this).call(this),i("input[name=wc_"+this.id+"_payment_nonce]").val("")}},{key:"verify_form",value:function(){var e;return this.has_payment_nonce()||!this.csc_required&&this.using_payment_token()?(e=i("input.js-wc-braintree-credit-card-payment-token:checked"),this.should_verify_3d_secure_token(e)?(this.verify_3d_secure(e.data("nonce"),e),!1):_get(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"verify_form",this).call(this)):(this.tokenize_payment(),!1)}},{key:"tokenize_payment",value:function(){var t=this;return this.integration.tokenize().then(function(e){if(t.log("payment method received",e),null!=e.nonce)return t.should_verify_3d_secure(e)?t.verify_3d_secure(e.nonce):t.submit_form(e.nonce)}).catch(function(e){return t.handle_payment_error(e)})}},{key:"get_integration_options",value:function(){var e;return e={client:this.client,fields:{number:{selector:"#wc-braintree-credit-card-account-number-hosted",placeholder:i("#wc-braintree-credit-card-account-number-hosted").data("placeholder")},cvv:{selector:"#wc-braintree-credit-card-csc-hosted",placeholder:i("#wc-braintree-credit-card-csc-hosted").data("placeholder")},expirationDate:{selector:"#wc-braintree-credit-card-expiry-hosted",placeholder:i("#wc-braintree-credit-card-expiry-hosted").data("placeholder")}},styles:this.hosted_fields_styles},this.csc_required&&this.using_payment_token()&&(delete e.fields.number,delete e.fields.expirationDate),this.csc_required||delete e.fields.cvv,e}},{key:"get_integration_class",value:function(){return braintree.hostedFields}},{key:"do_integration_ready",value:function(){var t=this;return this.integration.on("cardTypeChange",function(e){return t.on_card_type_change(e)}),!this.csc_required&&i("input.js-wc-braintree-credit-card-payment-token:checked").val()&&this.teardown_braintree(),this.unblock_ui()}},{key:"handle_saved_payment_methods",value:function(){var e,t,n=this;return _get(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"handle_saved_payment_methods",this).call(this),t=i("div.js-wc-braintree-credit-card-new-payment-method-form"),e=i("div.wc-braintree-hosted-field-card-csc-parent"),i("input.js-wc-braintree-credit-card-payment-token").change(function(){return i("input.js-wc-braintree-credit-card-payment-token:checked").val()?n.csc_required&&e.hasClass("form-row-last")?(e.removeClass("form-row-last").addClass("form-row-first"),t.after(e),n.refresh_braintree()):void 0:(n.csc_required&&e.hasClass("form-row-first")&&(e.removeClass("form-row-first").addClass("form-row-last"),t.find("div.wc-braintree-hosted-field-card-expiry-parent").after(e)),n.refresh_braintree())}).change()}},{key:"get_user_message",value:function(e){var t,n,r,i;if(r=[],"CUSTOMER"===e.type)switch(e.code){case"HOSTED_FIELDS_FIELDS_EMPTY":this.csc_required&&r.push(this.params.cvv_missing),this.using_payment_token()||(r.push(this.params.card_number_missing),r.push(this.params.card_exp_date_invalid));break;case"HOSTED_FIELDS_FIELDS_INVALID":if(null!=e.details)for(t=0,n=(i=e.details.invalidFieldKeys).length;t<n;t++)switch(i[t]){case"number":r.push(this.params.card_number_invalid);break;case"cvv":r.push(this.params.cvv_length_invalid);break;case"expirationDate":r.push(this.params.card_exp_date_invalid)}}return r.length?r.join("<br/>"):_get(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"get_user_message",this).call(this)}},{key:"on_card_type_change",value:function(e){var t,n,r;if(null!=e.cards)return(t=i("#wc-braintree-credit-card-account-number-hosted")).attr("class",function(e,t){return t.replace(/(^|\s)card-type-\S+/g,"")}),e.cards.length?1===e.cards.length?null!=(n=e.cards[0]).type&&(r=n.type,0<=o.call(this.enabled_card_types,r))?t.addClass("card-type-"+n.type):t.addClass("card-type-invalid"):void 0:t.addClass("card-type-invalid")}},{key:"is_3d_secure_enabled",value:function(){return this.threeds.enabled&&null!=braintree.threeDSecure}},{key:"setup_integration",value:function(){var t=this;return this.is_3d_secure_enabled()?braintree.threeDSecure.create({client:this.client}).then(function(e){return t.threeDSecure=e,i(document.body).on("click","#wc-braintree-credit-card-3dsecure-container",function(e){return i(e.currentTarget).fadeOut(200),t.threeDSecure.cancelVerifyCard(),t.unblock_ui()}),_get(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"setup_integration",t).call(t)}).catch(function(e){return t.handle_integration_error(e)}):_get(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"setup_integration",this).call(this)}},{key:"should_verify_3d_secure",value:function(e){var t;return t=e.details.cardType,this.is_3d_secure_enabled()&&"CreditCard"===e.type&&("Visa"===t||"MasterCard"===t)}},{key:"should_verify_3d_secure_token",value:function(e){if(e.val()&&e.data("nonce")&&!e.data("verified"))return!0}},{key:"verify_3d_secure",value:function(e){var n=this,t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;return this.threeDSecure.verifyCard({nonce:e,amount:i("input[name=wc_braintree_credit_card_3d_secure_order_total]").val(),addFrame:function(e,t){return n.add_3ds_ui(e,t)},removeFrame:function(){return n.remove_3ds_ui()}}).then(function(e){return n.log("3DS response",e),n.threeds.liability_shift_always_required&&!e.liabilityShifted&&n.render_error(n.threeds.failure_message),e.liabilityShiftPossible&&!e.liabilityShifted&&n.render_error(n.threeds.failure_message),null!=t&&t.data("verified",!0),i("input[name=wc_braintree_credit_card_3d_secure_verified]").val(1),n.submit_form(e.nonce)}).catch(function(e){return n.handle_payment_error(e)})}},{key:"add_3ds_ui",value:function(e,t){var n;return _(this,r),e?this.handle_payment_error(e):((n=i("<div>",{id:"wc-"+this.id_dasherized+"-3dsecure-container"})).html(t),i(document.body).append(n),n.fadeIn(400))}},{key:"remove_3ds_ui",value:function(){return _(this,r),i("#wc-"+this.id_dasherized+"-3dsecure-container").fadeOut(400,function(e){return i(this).remove()})}},{key:"show_integration_ui",value:function(){return _(this,r),_get(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"show_integration_ui",this).call(this),i(".wc-braintree-hosted-field-parent").show()}},{key:"hide_integration_ui",value:function(){return _(this,r),_get(a.prototype.__proto__||Object.getPrototypeOf(a.prototype),"hide_integration_ui",this).call(this),i(".wc-braintree-hosted-field-parent").hide()}}]),a}(),a=window.WC_Braintree_PayPal_Payment_Form_Handler=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.do_integration_ready=t.do_integration_ready.bind(t),t.on_authorize=t.on_authorize.bind(t),t.get_linked_account_html=t.get_linked_account_html.bind(t),t.is_test_environment=e.is_test_environment,t.must_login_message=e.must_login_message,t.must_login_add_method_message=e.must_login_add_method_message,t.button_styles=e.button_styles,t.init(),t}return _inherits(n,WC_Braintree_Payment_Form_Handler),_createClass(n,[{key:"init",value:function(){var t=this;return _get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"init",this).call(this),i("input[name=wc_"+this.id+"_payment_nonce]").val(this.params.cart_payment_nonce),i(document.body).on("click",'input[name="payment_method"], input.js-wc-braintree-paypal-payment-token',function(){return t.toggle_order_button()}),i(document.body).on("payment_method_selected",function(){return t.toggle_order_button()}),i(document.body).on("click",".wc-braintree-paypal-account .cancel",function(e){return e.preventDefault(),i(e.currentTarget).parent().remove(),t.setup_braintree()})}},{key:"toggle_order_button",value:function(){return!this.is_selected()||this.has_payment_nonce()||this.using_payment_token()?i("#place_order").show():i("#place_order").hide()}},{key:"verify_form",value:function(){var e;return e=_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"verify_form",this).call(this),this.has_payment_nonce()||this.using_payment_token()||this.render_error(this.must_login_message),e}},{key:"handle_payment_error",value:function(e){return _get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"handle_payment_error",this).call(this,e),this.params.cart_payment_nonce=!1,this.setup_braintree()}},{key:"get_integration_class",value:function(){return braintree.paypalCheckout}},{key:"setup_braintree",value:function(){return this.params.cart_payment_nonce?this.unblock_ui():(_get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"setup_braintree",this).call(this),i("input.js-wc-braintree-paypal-tokenize-payment-method").prop("disabled",!1),this.toggle_order_button())}},{key:"do_integration_ready",value:function(){var e,t=this;return _(this,a),this.params.cart_payment_nonce?this.unblock_ui():(e=this.is_single_use()?"checkout":"vault",this.integration.createPayment({flow:e,amount:this.get_order_amount(),currency:this.get_store_currency(),locale:this.get_store_locale()}).then(function(e){return t.render_button(e)}).then(function(){return i("#wc_braintree_paypal_container").css({width:"100%"}),t.unblock_ui()}).catch(function(e){return t.handle_integration_error(e),t.unblock_ui()}))}},{key:"render_button",value:function(e){var t,n=this;return i("#wc_braintree_paypal_container").html(""),t={env:this.is_test_environment?"sandbox":"production",commit:this.button_is_pay_now(),style:this.get_button_styles(),payment:function(){return e},onAuthorize:function(e,t){return n.on_authorize(e,t)},onError:function(e){return n.handle_integration_error(e)}},paypal.Button.render(t,"#wc_braintree_paypal_container")}},{key:"button_is_pay_now",value:function(){return!i("form#add_payment_method").length}},{key:"get_button_styles",value:function(){return this.button_styles}},{key:"on_authorize",value:function(e,t){var n=this;return _(this,a),this.block_ui(),this.integration.tokenizePayment(e).then(function(e){return n.log("PayPal method tokenized.",e),n.set_payment_method(e)}).catch(function(e){return n.handle_payment_error(e),n.unblock_ui()})}},{key:"set_payment_method",value:function(e){return i("input[name=wc_"+this.id+"_payment_nonce]").val(e.nonce),i("#wc_braintree_paypal_container").html(this.get_linked_account_html(e.details)),this.is_single_use()&&i("input.js-wc-braintree-paypal-tokenize-payment-method").prop("disabled",!0),i("#place_order").show(),this.form.submit()}},{key:"handle_saved_payment_methods",value:function(){var t=this;return _get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"handle_saved_payment_methods",this).call(this),i("input.js-wc-braintree-paypal-tokenize-payment-method").change(function(e){if(null!=t.integration&&i(e.target).is(":visible"))return t.block_ui(),t.do_integration_ready()}).change()}},{key:"get_linked_account_html",value:function(e){var t;return _(this,a),t=i("<div class='wc-"+this.id_dasherized+"-account'></div>"),null!=e.firstName&&null!=e.lastName&&t.append("<span class='name'>"+e.firstName+" "+e.lastName+"</span>"),t.append("<span class='email'>"+e.email+"</span>"),t.append("<a href='#' class='cancel'>Cancel</a>"),t}},{key:"is_single_use",value:function(){var e;return 0===(e=i("input[name=wc-braintree-paypal-tokenize-payment-method]")).length||("checkbox"===e.attr("type")?!e.is(":checked"):!e.val())}},{key:"get_order_amount",value:function(){return i("input[name=wc_braintree_paypal_amount]").val()}},{key:"get_store_currency",value:function(){return i("input[name=wc_braintree_paypal_currency]").val()}},{key:"get_store_locale",value:function(){return i("input[name=wc_braintree_paypal_locale]").val()}},{key:"is_sdk_ready",value:function(){return _get(n.prototype.__proto__||Object.getPrototypeOf(n.prototype),"is_sdk_ready",this).call(this)&&"undefined"!=typeof paypal&&null!==paypal}}]),n}(),window.WC_Braintree_PayPal_Cart_Handler=function(e){function n(e){_classCallCheck(this,n);var t=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,e));return t.form=i("form.woocommerce-cart-form"),t.form_ui_selector="",t.setup_braintree(),i(document.body).on("updated_cart_totals",function(){return t.setup_braintree()}),t}return _inherits(n,WC_Braintree_PayPal_Payment_Form_Handler),_createClass(n,[{key:"button_is_pay_now",value:function(){return!1}},{key:"set_payment_method",value:function(e){var t=this;if(null!=e.nonce)return e.wp_nonce=this.params.cart_nonce,i.ajax({type:"POST",url:this.params.cart_handler_url,data:e,dataType:"json"}).done(function(e){if(t.log("PayPal Cart response",e),null!=e.redirect_url)return window.location=e.redirect_url}).fail(function(e){return t.log("Error setting the PayPal cart data.",e)}).always(function(){return t.unblock_ui()})}},{key:"is_single_use",value:function(){return"1"===i("input[name=wc_braintree_paypal_single_use]").val()}},{key:"has_payment_nonce",value:function(){return!1}}]),n}()})}).call(void 0);